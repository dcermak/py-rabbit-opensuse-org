---
name: CI

on:
  push:
    branches:
      - "main"
  pull_request:

jobs:
  format:
    name: Ensure code is properly formatted
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('pyproject.toml') }}

      - run: pip install tox
      - run: tox -e format -- --check --diff

  lint:
    name: Lint the source code
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('pyproject.toml') }}

      - run: pip install tox
      - run: tox run -e lint
      - run: tox run -e mypy

  test:
    name: Run backend tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python_version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        backend: ["pydantic-v1", "pydantic-v2", "dataclassy"]
        exclude:
          - python_version: "3.14"
            backend: "dataclassy"
          - python_version: "3.14"
            backend: "pydantic-v1"

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python_version }}
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('pyproject.toml') }}

      - run: pip install tox
      - name: Run tests
        run: |
          VERSION=$(echo "${{ matrix.python_version }}" | tr -d '.')
          tox -e test-py${VERSION}-${{ matrix.backend }}

  documentation:
    name: Build the documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('pyproject.toml') }}

      - run: pip install tox
      - run: tox -e doc

      - name: upload the build directory
        uses: actions/upload-artifact@v5
        with:
          name: docs
          path: ./build/html

  deploy:
    name: deploy to the gh-pages branch
    runs-on: ubuntu-latest
    needs: documentation
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v6
        with:
          name: docs
          path: ./build/html

      - run: touch ./build/html/.nojekyll

      - name: deploy to github pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: build/html

  build:
    name: Build the package
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('pyproject.toml') }}

      - name: Run the build
        run: |
          pip install build
          python -m build

      - uses: actions/upload-artifact@v5
        with:
          name: wheel
          path: dist/*.whl
          if-no-files-found: error

  install:
    name: Install and test the package
    runs-on: "ubuntu-latest"
    needs: build
    strategy:
      fail-fast: false
      matrix:
        python_version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        backend: ["pydantic", "dataclassy"]
        exclude:
          - python_version: "3.14"
            backend: "dataclassy"

    steps:
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python_version }}

      - uses: actions/download-artifact@v6
        with:
          name: wheel
          path: dist

      - name: install the wheel
        run: pip install --user dist/*.whl

      - name: install backend dependencies
        run: |
          if [ "${{ matrix.backend }}" = "pydantic" ]; then
            pip install --user pydantic
          else
            pip install --user dataclassy
          fi

      - name: run a smoke test that the package has been installed
        run: |
          python -c "
          from py_rodo.config import set_backend
          set_backend('${{ matrix.backend }}')
          from py_rodo import QueueProcessor
          print('py_rodo imported successfully with ${{ matrix.backend }} backend')
          "

      - name: verify try-listening works
        run: |
          python -m py_rodo.cli --backend ${{ matrix.backend }} --help
